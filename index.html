<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Executive 35-Day Extreme Focus Timetable (Editable)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for the chart visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BRIGHT COLOR PALETTE: Vibrant Cyan/Teal and Mint Green */
        :root {
            --color-primary: #00ADB5; /* Vibrant Cyan */
            --color-secondary: #393E46; /* Dark Slate for contrast */
            --color-background: #F4F9F9; /* Very Light Pale Cyan/White */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-secondary);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        /* Updated Glassmorphism with slight background tint */
        .glassmorphism-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 173, 181, 0.1); /* Slight cyan border */
        }
        /* Visual cue for completed tasks */
        .completed {
            opacity: 0.5;
            text-decoration: line-through;
            transition: opacity 0.3s ease;
        }
        .plan-card:hover {
            box-shadow: 0 4px 15px rgba(0, 173, 181, 0.2);
            transform: translateY(-2px);
            transition: all 0.2s ease-in-out;
        }
        .subject-input:focus {
            border-bottom: 2px solid var(--color-primary);
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-[--color-primary]">CS Executive 35-Day Extreme Focus Timetable</h1>
            <p class="mt-2 text-lg text-[--color-secondary]">2 x 6-hour slots/day, now fully **editable** and saved.</p>
        </header>

        <main class="space-y-12">
            
            <section id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glassmorphism-card p-5 rounded-xl shadow-xl text-center">
                    <h3 class="text-lg font-semibold text-[--color-secondary]">Total Subjects</h3>
                    <p class="text-4xl font-bold text-[--color-primary] mt-2">4</p>
                </div>
                <div class="glassmorphism-card p-5 rounded-xl shadow-xl text-center">
                    <h3 class="text-lg font-semibold text-[--color-secondary]">Daily Study Slots</h3>
                    <p class="text-4xl font-bold text-[--color-primary] mt-2">2</p>
                </div>
                <div class="glassmorphism-card p-5 rounded-xl shadow-xl text-center">
                    <h3 class="text-lg font-semibold text-[--color-secondary]">Total Days</h3>
                    <p class="text-4xl font-bold text-[--color-primary] mt-2">35</p>
                </div>
                <div class="glassmorphism-card p-5 rounded-xl shadow-xl text-center">
                    <h3 class="text-lg font-semibold text-[--color-secondary]">Slot Duration</h3>
                    <p class="text-4xl font-bold text-[--color-primary] mt-2">6 hrs</p>
                </div>
            </section>
            
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
                 <div class="lg:col-span-1 glassmorphism-card p-6 rounded-xl shadow-xl h-[400px] flex flex-col">
                    <h2 class="text-xl font-bold text-[--color-secondary] text-center mb-4">Subject Workload</h2>
                     <div class="chart-container flex-grow">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 glassmorphism-card p-6 rounded-xl shadow-xl h-full">
                    <h2 class="text-xl font-bold text-[--color-secondary] mb-4">Daily Study Block Structure (12 Hrs Total)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-[--color-primary]/20 text-[--color-secondary]">
                                <tr>
                                    <th class="p-3 rounded-tl-lg">Study Block</th>
                                    <th class="p-3">Duration</th>
                                    <th class="p-3 rounded-tr-lg">Primary Focus</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-[--color-primary]/20">
                                    <td class="p-3 font-medium">Slot 1</td>
                                    <td class="p-3">6 hrs</td>
                                    <td class="p-3">Deep Dive, Major Chapter Completion (Focus Subject A)</td>
                                </tr>
                                <tr class="border-b border-[--color-primary]/20">
                                    <td class="p-3 font-medium">Slot 2</td>
                                    <td class="p-3">6 hrs</td>
                                    <td class="p-3">Application, Full Subject Practice, and Revision (Focus Subject B)</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-medium rounded-bl-lg">Break Time</td>
                                    <td class="p-3">2-3 Hrs</td>
                                    <td class="p-3 rounded-br-lg">Walks, Meals, Self-Quizzing, Rest</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="plan-viewer" class="glassmorphism-card p-6 rounded-xl shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-[--color-secondary]">Plan Explorer</h2>
                    <div class="flex items-center gap-4">
                        <label for="day-selector" class="font-semibold text-[--color-secondary]">Go to Day:</label>
                        <select id="day-selector" class="bg-white border border-[--color-primary]/50 rounded-lg p-2 focus:ring-2 focus:ring-[--color-primary] focus:border-[--color-primary] transition"></select>
                    </div>
                </div>

                <div class="flex justify-center mb-6">
                    <div class="flex items-center p-1 bg-[--color-primary]/10 rounded-lg">
                        <button id="prev-day" class="px-4 py-2 text-lg font-bold text-[--color-primary] rounded-md hover:bg-[--color-primary]/20 transition-colors duration-300">←</button>
                        <h3 id="current-day-title" class="text-xl font-bold text-[--color-secondary] mx-4 w-24 text-center">Day 1</h3>
                        <button id="next-day" class="px-4 py-2 text-lg font-bold text-[--color-primary] rounded-md hover:bg-[--color-primary]/20 transition-colors duration-300">→</button>
                    </div>
                </div>
                
                <div id="daily-plan-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Daily plan cards will be rendered here -->
                    <p class="col-span-full text-center text-gray-500" id="loading-message">Loading schedule data...</p>
                </div>

            </section>
            
            <section id="tips-section" class="glassmorphism-card p-6 rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-[--color-secondary] mb-4">Tips for Maximize Efficiency (2x6 Hour Slots)</h2>
                <ul class="space-y-3 list-disc list-inside text-[--color-secondary]">
                    <li><span class="font-semibold">6-Hour Immersion:</span> Use this long block for a single, non-negotiable goal: either completing a major chapter, solving 40+ complex numerical problems, or writing out two full mock answers.</li>
                    <li><span class="font-semibold">Internal Breaks:</span> Within the 6-hour slot, enforce 5-minute movement breaks every 90 minutes to maintain concentration and prevent burnout.</li>
                    <li><span class="font-semibold">Slot Transition:</span> The gap between Slot 1 and Slot 2 must be substantial (at least 1.5 hours) for deep rest, meal, and complete mental context-switching.</li>
                    <li><span class="font-semibold">Integrated Revision:</span> The last 30 minutes of each 6-hour slot should be *pure active recall*—quizzing yourself on everything covered, without referencing the material.</li>
                </ul>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, runTransaction, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // setLogLevel('debug'); // Uncomment for debugging Firestore

        const MAX_DAYS = 35; 

        // Global Firebase variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let currentDay = 1;
        let unsubscribe = null; // To hold the Firestore listener unsubscribe function
        let currentDayData = null; // Data fetched from Firestore for the current day

        // Subject data for color mapping (used for UI, not stored in Firestore)
        const subjectData = {
            'JIGL': { name: 'Jurisprudence, Interpretation & General Laws', color: '#00ADB5' },
            'CL': { name: 'Company Law', color: '#4ECCA3' }, 
            'SBIL': { name: 'Securities Laws & Industrial Laws', color: '#FFD369' },
            'CAFM': { name: 'Corporate Accounting & Financial Management', color: '#393E46' },
            'MASTER': { name: 'MASTERY SPRINT', color: '#FF6384' } 
        };
        
        // Initial schedule data to populate Firestore (if empty)
        const initialScheduleData = [
            // Subject codes are used for subject/color mapping
            { day: 1, slot1_subject: 'JIGL', slot2_subject: 'CL' },
            { day: 2, slot1_subject: 'SBIL', slot2_subject: 'CL' },
            { day: 3, slot1_subject: 'CAFM', slot2_subject: 'JIGL' },
            { day: 4, slot1: { subject: 'CL' }, slot2_subject: 'CAFM' },
            { day: 5, slot1_subject: 'SBIL', slot2_subject: 'JIGL' },
            { day: 6, slot1_subject: 'CAFM', slot2_subject: 'CL' },
            { day: 7, slot1_subject: 'JIGL', slot2_subject: 'SBIL' },
            { day: 8, slot1_subject: 'CL', slot2_subject: 'CAFM' },
            { day: 9, slot1_subject: 'SBIL', slot2_subject: 'CL' },
            { day: 10, slot1_subject: 'CAFM', slot2_subject: 'JIGL' },
            { day: 11, slot1_subject: 'JIGL', slot2_subject: 'SBIL' },
            { day: 12, slot1_subject: 'CL', slot2_subject: 'CAFM' },
            { day: 13, slot1_subject: 'SBIL', slot2_subject: 'JIGL' },
            { day: 14, slot1_subject: 'CAFM', slot2_subject: 'CL' },
            { day: 15, slot1_subject: 'JIGL', slot2_subject: 'SBIL' },
            { day: 16, slot1_subject: 'CL', slot2_subject: 'CAFM' },
            { day: 17, slot1_subject: 'SBIL', slot2_subject: 'CL' },
            { day: 18, slot1_subject: 'CAFM', slot2_subject: 'JIGL' },
            { day: 19, slot1_subject: 'JIGL', slot2_subject: 'SBIL' },
            { day: 20, slot1_subject: 'CL', slot2_subject: 'CAFM' },
            { day: 21, slot1_subject: 'SBIL', slot2_subject: 'CL' },
            { day: 22, slot1_subject: 'CAFM', slot2_subject: 'JIGL' },
            { day: 23, slot1_subject: 'JIGL', slot2_subject: 'SBIL' },
            { day: 24, slot1_subject: 'CL', slot2_subject: 'CAFM' },
            { day: 25, slot1_subject: 'JIGL', slot2_subject: 'CL' },
            { day: 26, slot1_subject: 'SBIL', slot2_subject: 'CAFM' },
            { day: 27, slot1_subject: 'CL', slot2_subject: 'JIGL' },
            { day: 28, slot1_subject: 'CAFM', slot2_subject: 'SBIL' },
            { day: 29, slot1_subject: 'JIGL', slot2_subject: 'CL' },
            { day: 30, slot1_subject: 'SBIL', slot2_subject: 'CAFM' },
            { day: 31, slot1_subject: 'MASTER', slot2_subject: 'MASTER' },
            { day: 32, slot1_subject: 'MASTER', slot2_subject: 'MASTER' },
            { day: 33, slot1_subject: 'MASTER', slot2_subject: 'MASTER' },
            { day: 34, slot1_subject: 'MASTER', slot2_subject: 'MASTER' },
            { day: 35, slot1_subject: 'MASTER', slot2_subject: 'MASTER' }
        ].map(dayData => ({
            ...dayData,
            slot1_completed: false,
            slot2_completed: false
        }));


        const daySelector = document.getElementById('day-selector');
        const currentDayTitle = document.getElementById('current-day-title');
        const dailyPlanContent = document.getElementById('daily-plan-content');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const loadingMessage = document.getElementById('loading-message');

        // --- FIREBASE FUNCTIONS ---

        async function firebaseInit() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                await initializeScheduleIfEmpty();
                
                loadingMessage.textContent = 'Data synced.';
                loadingMessage.classList.add('hidden');

                // Start the listener for the current day
                setupDayListener(currentDay);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.textContent = "Error loading schedule. Check console for details.";
            }
        }

        // Path for public/shared data
        function getDayDocRef(day) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'schedule', `day_${day}`);
        }
        
        async function initializeScheduleIfEmpty() {
            const scheduleColRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedule');
            const snapshot = await getDocs(query(scheduleColRef));

            if (snapshot.empty) {
                console.log("Initializing schedule in Firestore...");
                
                // Use a transaction for batch writing for efficiency
                await runTransaction(db, async (transaction) => {
                    for (const data of initialScheduleData) {
                        const ref = getDayDocRef(data.day);
                        transaction.set(ref, data);
                    }
                });
                console.log("Schedule initialized successfully.");
            } else {
                console.log("Schedule already exists in Firestore. Skipping initialization.");
            }
        }

        function setupDayListener(day) {
            // Unsubscribe from previous listener if it exists
            if (unsubscribe) {
                unsubscribe();
            }

            const ref = getDayDocRef(day);
            
            // Set up new listener for the current day's data
            unsubscribe = onSnapshot(ref, (docSnap) => {
                if (docSnap.exists()) {
                    currentDayData = docSnap.data();
                    renderDailyView();
                } else {
                    console.error(`Document for day ${day} not found.`);
                    dailyPlanContent.innerHTML = `<p class="col-span-full text-center text-red-500">Error: Schedule for Day ${day} not found.</p>`;
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                dailyPlanContent.innerHTML = `<p class="col-span-full text-center text-red-500">Connection Error. Data may be out of sync.</p>`;
            });
        }

        // Function to update the subject name in Firestore
        window.updateSubject = async function(day, slotIndex, newSubject) {
            const subjectKey = `slot${slotIndex}_subject`;
            const ref = getDayDocRef(day);
            
            try {
                await setDoc(ref, { [subjectKey]: newSubject.toUpperCase().trim() }, { merge: true });
                console.log(`Day ${day}, Slot ${slotIndex} subject updated to: ${newSubject}`);
            } catch (error) {
                console.error("Error updating subject:", error);
            }
        }

        // Function to toggle completion status in Firestore
        window.toggleCompletion = async function(checkboxElement, day, slotIndex) {
            const completionKey = `slot${slotIndex}_completed`;
            const isCompleted = checkboxElement.checked;
            const ref = getDayDocRef(day);

            try {
                await setDoc(ref, { [completionKey]: isCompleted }, { merge: true });
                console.log(`Day ${day}, Slot ${slotIndex} completion set to: ${isCompleted}`);
            } catch (error) {
                console.error("Error toggling completion:", error);
            }
        }

        // --- RENDERING FUNCTIONS ---

        function getSubjectInfo(subjectCode) {
            const code = subjectCode.toUpperCase().trim();
            const info = subjectData[code];
            // If the user types a custom subject, use a fallback color/name structure
            return info || { name: code, color: '#9B59B6' }; // Default color for custom subjects
        }
        
        function populateDaySelector() {
            daySelector.innerHTML = ''; 
            for (let i = 1; i <= MAX_DAYS; i++) { 
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Day ${i}`;
                daySelector.appendChild(option);
            }
        }
        
        function createPlanCard(slotIndex, day, data) {
            const subjectKey = `slot${slotIndex}_subject`;
            const completionKey = `slot${slotIndex}_completed`;
            
            const subjectCode = data[subjectKey] || 'N/A';
            const isCompleted = data[completionKey] || false;
            
            const subjectInfo = getSubjectInfo(subjectCode);
            let subjectDisplayName = subjectInfo.name;

            // Use the subject code if the code is one of the four main subjects, otherwise use the typed value as the display name
            if (subjectData[subjectCode] && subjectData[subjectCode].name) {
                // If it's a standard subject, use the short code for the input value
                subjectDisplayName = subjectCode;
            } else {
                // If it's a custom subject, use the custom name
                subjectDisplayName = subjectCode;
            }
             
            const checkboxId = `task-day-${day}-slot-${slotIndex}`;
             
            return `
                <div class="plan-card border-l-4 p-4 rounded-xl bg-white/50 shadow flex flex-col justify-between ${isCompleted ? 'completed' : ''}" style="border-color: ${subjectInfo.color};">
                    <div class="flex items-start justify-between">
                        <label for="${checkboxId}" class="flex-grow cursor-pointer">
                            <p class="text-sm font-semibold" style="color: ${subjectInfo.color};">Slot ${slotIndex} (6 Hours)</p>
                            <div class="mt-1 space-y-2">
                                <div>
                                    <!-- Editable Subject Input -->
                                    <input 
                                        type="text" 
                                        value="${subjectDisplayName}" 
                                        placeholder="Enter Subject Code (e.g., CL, JIGL)"
                                        class="subject-input text-lg font-bold w-full bg-transparent border-b border-gray-300 focus:border-[--color-primary] focus:outline-none transition-colors duration-200 p-0 m-0"
                                        onblur="updateSubject(${day}, ${slotIndex}, this.value)"
                                    />
                                </div>
                            </div>
                        </label>
                        <input 
                            type="checkbox" 
                            id="${checkboxId}" 
                            class="h-6 w-6 ml-4 text-[--color-primary] bg-gray-100 border-gray-300 rounded focus:ring-[--color-primary] focus:ring-2 cursor-pointer"
                            data-day="${day}"
                            data-slot="${slotIndex}"
                            ${isCompleted ? 'checked' : ''}
                            onchange="toggleCompletion(this, ${day}, ${slotIndex})"
                        >
                    </div>
                </div>
            `;
        }

        function renderDailyView() {
            // Check if Firebase data has been loaded
            if (!currentDayData) return;

            currentDayTitle.textContent = `Day ${currentDay}`;
            daySelector.value = currentDay;
            
            // Render two cards using the data retrieved from Firestore
            dailyPlanContent.innerHTML = `
                ${createPlanCard(1, currentDay, currentDayData)}
                ${createPlanCard(2, currentDay, currentDayData)}
            `;

            prevDayBtn.disabled = currentDay === 1;
            nextDayBtn.disabled = currentDay === MAX_DAYS;
            prevDayBtn.classList.toggle('opacity-50', currentDay === 1);
            nextDayBtn.classList.toggle('opacity-50', currentDay === MAX_DAYS);
        }
        
        function createSubjectChart() {
            const ctx = document.getElementById('subjectChart').getContext('2d');
            
            const standardSubjects = Object.values(subjectData).filter(s => s.name.includes('Law') || s.name.includes('Management')); 
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: standardSubjects.map(s => s.name.split(' (')[0]),
                    datasets: [{
                        label: 'Subjects',
                        // Use placeholder data for the chart since chapter counts were removed in the previous prompt
                        data: [25, 25, 25, 25], 
                        backgroundColor: standardSubjects.map(s => s.color),
                        borderColor: 'var(--color-background)',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 15,
                                font: { size: 12, family: 'Inter' },
                                color: 'var(--color-secondary)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ' (Study Weight)';
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Module 1 Study Balance',
                            font: { family: 'Inter', size: 14 }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function handleNavigation() {
            prevDayBtn.addEventListener('click', () => {
                if (currentDay > 1) {
                    currentDay--;
                    setupDayListener(currentDay);
                }
            });

            nextDayBtn.addEventListener('click', () => {
                if (currentDay < MAX_DAYS) { 
                    currentDay++;
                    setupDayListener(currentDay);
                }
            });

            daySelector.addEventListener('change', (e) => {
                currentDay = parseInt(e.target.value);
                setupDayListener(currentDay);
            });
        }

        function init() {
            populateDaySelector();
            handleNavigation();
            createSubjectChart();
            firebaseInit(); // Start the Firebase flow
        }

        init();
    </script>
</body>
</html>
